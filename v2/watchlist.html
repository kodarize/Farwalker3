<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Watchlist</title>
  <meta name="description" content="Upcoming releases + local showtimes, with premium-format preference and group voting." />
  <style>
    :root{
      --bg:#0b0f17; --panel:rgba(255,255,255,.04); --panel2:rgba(15,23,42,.6);
      --text:#e5e7eb; --muted:#9ca3af; --border:rgba(255,255,255,.10);
      --good:#34d399;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    header,main,footer{max-width:1150px;margin:0 auto;padding:0 20px}
    header{padding:44px 0 18px;display:flex;justify-content:space-between;gap:16px;flex-wrap:wrap;align-items:flex-end}
    h1{margin:0;font-size:34px}
    .sub{color:var(--muted);margin-top:8px;line-height:1.4}
    .card{border:1px solid var(--border);border-radius:16px;overflow:hidden;background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02))}
    .cardhead{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{font-size:12px;color:var(--muted)}
    input,select{background:rgba(255,255,255,.05);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;outline:none}
    button{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.18);color:var(--text);border-radius:10px;padding:10px 12px;cursor:pointer}
    button:hover{background:rgba(255,255,255,.10)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .status{padding:10px 12px;border:1px dashed var(--border);border-radius:12px;color:var(--muted);background:var(--panel)}
    .content{padding:16px}
    .pill{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:var(--panel)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .hallWrap{padding:16px;border-bottom:1px solid var(--border);background:rgba(255,255,255,.02)}
    .hallTop{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .hall{display:flex;gap:12px;overflow:auto;padding-bottom:6px;scrollbar-width:thin}
    .poster{
      width:140px; flex:0 0 140px; border-radius:14px; overflow:hidden; border:1px solid var(--border);
      background:rgba(255,255,255,.03); cursor:pointer; transition:transform .12s ease, border-color .12s ease;
    }
    .poster:hover{transform:translateY(-2px);border-color:rgba(255,255,255,.22)}
    .poster.sel{border-color:rgba(52,211,153,.65); box-shadow:0 0 0 1px rgba(52,211,153,.25) inset}
    .poster img{display:block;width:100%;height:205px;object-fit:cover}
    .poster .ptitle{padding:8px 8px 6px;font-size:12px;color:var(--text);line-height:1.2}
    .poster .pmeta{padding:0 8px 10px;font-size:11px;color:var(--muted)}
    .groups{display:grid;gap:14px;margin-top:14px}
    .gtitle{display:flex;justify-content:space-between;align-items:baseline;gap:10px;flex-wrap:wrap}
    .gtitle h2{margin:0;font-size:15px;color:var(--text)}
    .gtitle .hint{color:var(--muted);font-size:12px}
    .event{
      display:grid; grid-template-columns: 1.25fr 1fr; gap:12px;
      padding:12px; border:1px solid var(--border); border-radius:14px;
      background:var(--panel2);
    }
    .event h3{margin:0 0 6px;font-size:16px}
    .meta{color:var(--muted);font-size:12px;line-height:1.35}
    .badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .badge{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid var(--border);background:var(--panel);color:var(--muted)}
    .badge.good{border-color:rgba(52,211,153,.35);background:rgba(52,211,153,.12);color:rgba(167,243,208,.95)}
    .right{display:flex;flex-direction:column;gap:10px;align-items:flex-end}
    .voteRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
    .voteBtn{background:rgba(52,211,153,.14);border:1px solid rgba(52,211,153,.35)}
    .voteBtn:hover{background:rgba(52,211,153,.22)}
    .link{font-size:12px;color:var(--text);text-decoration:none;border:1px solid var(--border);padding:8px 10px;border-radius:10px;background:var(--panel)}
    .link:hover{border-color:rgba(255,255,255,.2)}
    footer{padding:18px 20px 60px;color:var(--muted);font-size:12px;line-height:1.5}
    @media (max-width:900px){.event{grid-template-columns:1fr}.right{align-items:flex-start}.voteRow{justify-content:flex-start}}
  </style>
</head>
<body>

<header>
  <div>
    <h1>Watchlist</h1>
    <div class="sub">Upcoming releases + local showtimes, with premium-format preference and group voting.</div>
    <div class="row" style="margin-top:10px">
      <span class="pill">Prefers: 3D / IMAX</span>
      <span class="pill">Preferred theater: Smitty’s (Sanford)</span>
      <span class="pill">Auto-hides past showtimes</span>
    </div>
  </div>
</header>

<main>
  <section class="card">
    <div class="cardhead">
      <div>
        <strong>Nearby showtimes</strong>
        <div class="meta">MovieGlu primary, SerpApi fallback.</div>
      </div>
      <div class="controls">
        <div>
          <label for="zip">ZIP</label><br/>
          <input id="zip" value="04002" />
        </div>
        <div>
          <label for="radius">Max distance</label><br/>
          <select id="radius">
            <option value="25">25 miles</option>
            <option value="40" selected>40 miles</option>
            <option value="60">60 miles</option>
          </select>
        </div>
        <button id="refresh">Refresh</button>
      </div>
    </div>

    <div class="hallWrap">
      <div class="hallTop">
        <div class="meta" id="hallHint">Click Refresh to load posters.</div>
        <div class="row">
          <button id="clearFilter">All movies</button>
        </div>
      </div>
      <div class="hall" id="hall"></div>
    </div>

    <div class="content">
      <div class="status" id="status">Ready. Click “Refresh”.</div>
      <div id="results"></div>

      <!-- ✅ EDIT ONLY THIS LIST -->
      <ol id="movieTitles" style="display:none">
        <li data-title="THE SPONGEBOB MOVIE: SEARCH FOR SQUAREPANTS"></li>
        <li data-title="ZOOTOPIA 2"></li>
        <li data-title="MERCY"></li>
        <li data-title="IRON LUNG"></li>
      </ol>
    </div>
  </section>
</main>

<footer>
  Voting is anonymous and temporary. Votes auto-expire after the showtime passes.
</footer>

<script>
  const WORKER_BASE = "https://watchlist-api.farwalker3.workers.dev";

  const PREMIUM = new Set(["3D","IMAX","IMAX3D","3DIMAX"]);
  const PREF_THEATER = { nameIncludes: "Smitty", cityIncludes: "Sanford" };

  const LOCAL_VOTE_KEY = "watchlist_voted_showtimes_v1";

  const $ = (id) => document.getElementById(id);
  const fmtDay = (d) => d.toLocaleDateString(undefined, { weekday:"short", month:"short", day:"numeric", year:"numeric" });

  let selectedTitle = null;
  let lastEvents = [];
  let lastZip = "04002";
  let refreshInFlight = false;

  function posterUrl(posterPath) {
    return posterPath ? `https://image.tmdb.org/t/p/w342${posterPath}` : null;
  }

  function isPreferredTheater(name="", city="") {
    return name.toLowerCase().includes(PREF_THEATER.nameIncludes.toLowerCase()) &&
           city.toLowerCase().includes(PREF_THEATER.cityIncludes.toLowerCase());
  }

  function rankScore(ev) {
    let s = 0;
    if (PREMIUM.has(String(ev.format).toUpperCase())) s += 30;
    if (isPreferredTheater(ev.cinema_name, ev.cinema_city)) s += 60;
    if (ev.distance != null) s += Math.max(0, 25 - ev.distance);
    return s;
  }

  function groupName(score) {
    if (score >= 70) return "Preferred";
    if (score >= 35) return "Recommended";
    return "Standard";
  }

  function getLocalVotedSet() {
    try { return new Set(JSON.parse(localStorage.getItem(LOCAL_VOTE_KEY) || "[]")); }
    catch { return new Set(); }
  }
  function markVoted(showtimeKey) {
    const s = getLocalVotedSet();
    s.add(showtimeKey);
    localStorage.setItem(LOCAL_VOTE_KEY, JSON.stringify([...s]));
  }

  async function geocodeZip(zip) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&country=US&postalcode=${encodeURIComponent(zip)}`;
    const res = await fetch(url, { headers: { "Accept":"application/json" } });
    const data = await res.json();
    if (!data?.[0]) throw new Error("Could not geocode ZIP.");
    return { lat: Number(data[0].lat), lng: Number(data[0].lon) };
  }

  async function tmdbSearch(title) {
    const u = new URL(WORKER_BASE.replace(/\/+$/,"") + "/tmdb/search");
    u.searchParams.set("title", title);
    const r = await fetch(u.toString(), { headers: { "Accept":"application/json" } });
    const j = await r.json().catch(()=> ({}));
    if (!r.ok) throw new Error(j?.error || `TMDB error ${r.status}`);
    return j;
  }

  async function getVotes(keys) {
    if (!keys.length) return {};
    const u = new URL(WORKER_BASE.replace(/\/+$/,"") + "/votes");
    u.searchParams.set("keys", keys.join(","));
    const r = await fetch(u.toString(), { headers: { "Accept":"application/json" } });
    const j = await r.json().catch(()=> ({}));
    return j?.votes || {};
  }

  async function vote(showtimeKey, expiresAtEpochMs) {
    const u = WORKER_BASE.replace(/\/+$/,"") + "/vote";
    const r = await fetch(u, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ showtimeKey, expiresAtEpochMs })
    });
    const j = await r.json().catch(()=> ({}));
    if (!r.ok) throw new Error(j?.error || `Vote error ${r.status}`);
    return j;
  }

  // ---- UI wiring ----
  $("clearFilter").addEventListener("click", () => setFilter(null));
  $("refresh").addEventListener("click", () => refresh());

  async function setFilter(titleOrNull) {
    selectedTitle = titleOrNull;

    for (const el of document.querySelectorAll(".poster")) {
      el.classList.toggle("sel", el.dataset.title === selectedTitle);
    }

    if (!selectedTitle) {
      lastEvents = [];
      renderResults();
      $("status").textContent = "Select a poster to load showtimes.";
      return;
    }

    await loadShowtimesForSelected().catch(e => {
      $("status").textContent = `Error: ${e.message || e}`;
      lastEvents = [];
      renderResults();
    });
  }

  async function refresh() {
    if (refreshInFlight) return;
    refreshInFlight = true;

    try {
      const zip = $("zip").value.trim();
      lastZip = zip;

      $("status").textContent = "Loading posters…";

      const titles = [...document.querySelectorAll("#movieTitles li")]
        .map(li => li.getAttribute("data-title"))
        .filter(Boolean);

      const posterData = await Promise.all(titles.map(async (t) => {
        try { return await tmdbSearch(t); }
        catch { return { title: t, tmdb: null }; }
      }));

      const hall = $("hall");
      hall.innerHTML = "";
      for (const p of posterData) {
        const img = posterUrl(p.tmdb?.poster_path);
        const el = document.createElement("div");
        el.className = "poster";
        el.dataset.title = p.title;
        el.innerHTML = `
          ${img ? `<img alt="${p.title}" src="${img}">` : `<div style="height:205px;display:grid;place-items:center;color:var(--muted);padding:12px;">No poster</div>`}
          <div class="ptitle">${p.tmdb?.name || p.title}</div>
          <div class="pmeta">${p.tmdb?.release_date || ""}</div>
        `;
        el.addEventListener("click", () => setFilter(p.title));
        hall.appendChild(el);
      }

      $("hallHint").textContent = "Click a poster to load showtimes (MovieGlu → SerpApi fallback).";
      $("status").textContent = "Posters loaded. Click a poster to load showtimes.";
      lastEvents = [];
      renderResults();

    } finally {
      refreshInFlight = false;
    }
  }

  async function loadShowtimesForSelected() {
    if (refreshInFlight) return;
    refreshInFlight = true;

    try {
      const zip = $("zip").value.trim();
      const radius = Number($("radius").value);
      lastZip = zip;

      $("status").textContent = `Loading showtimes for: ${selectedTitle}`;

      const geo = await geocodeZip(zip);

      const u = new URL(WORKER_BASE.replace(/\/+$/,"") + "/showtimes");
      u.searchParams.set("title", selectedTitle);
      u.searchParams.set("zip", zip);
      u.searchParams.set("radius", String(radius));
      u.searchParams.set("lat", String(geo.lat));
      u.searchParams.set("lng", String(geo.lng));

      const r = await fetch(u.toString(), { headers: { "Accept":"application/json" } });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(j?.error || `Showtimes error ${r.status}`);

      // Normalize to our UI event list
      if (j.provider === "movieglu" && Array.isArray(j.items)) {
        lastEvents = normalizeItemsToEvents(j.items);
        $("status").textContent = `Loaded from MovieGlu (${lastEvents.length} showtimes).`;
      } else if (j.provider === "serpapi") {
        // SerpApi fallback: may not have parsed items yet
        lastEvents = normalizeItemsToEvents(j.items || []);
        $("status").textContent = lastEvents.length
          ? `Loaded fallback from SerpApi (${lastEvents.length} showtimes).`
          : `Fallback: SerpApi returned limited structured showtime data.`;
        // If no items, show a fallback “links card” in the results area
        if (!lastEvents.length) {
          renderFallbackCard(j);
          return;
        }
      } else {
        lastEvents = [];
        renderFallbackCard(j);
        return;
      }

      // Votes
      const keys = lastEvents.map(e => e.showtimeKey);
      const voteMap = await getVotes(keys.slice(0, 500));
      for (const ev of lastEvents) ev.votes = voteMap[ev.showtimeKey] || 0;

      renderResults();

    } finally {
      refreshInFlight = false;
    }
  }

  function normalizeItemsToEvents(items) {
    const now = Date.now();
    const events = [];

    for (const it of items) {
      const when = Number(it.when_epoch_ms || 0);
      if (!when || when <= now) continue;

      const ev = {
        title: it.title || selectedTitle,
        dayKey: (it.date || new Date(when).toISOString().slice(0,10)),
        start_time: it.start_time || new Date(when).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}),
        when,
        cinema_name: it.theater_name || it.theatre_name || "Theater",
        cinema_city: it.theater_city || it.theatre_city || "",
        distance: (it.distance_miles != null ? Number(it.distance_miles) : null),
        format: it.format || "Standard",
        showtimeKey: it.showtimeKey,
        booking_url: it.booking_url || null,
        votes: 0
      };

      ev.score = rankScore(ev);
      ev.bucket = groupName(ev.score);
      events.push(ev);
    }

    return events;
  }

  function renderFallbackCard(payload) {
    const root = $("results");
    root.innerHTML = `
      <div class="event" style="grid-template-columns:1fr;">
        <div>
          <h3>${payload.title || selectedTitle}</h3>
          <div class="meta">
            Provider used: <strong>${payload.provider || "unknown"}</strong><br/>
            ${payload.note ? payload.note + "<br/>" : ""}
            ${payload.message ? payload.message + "<br/>" : ""}
          </div>
          <div class="badges" style="margin-top:12px;">
            <span class="badge">ZIP: ${$("zip").value.trim()}</span>
            <span class="badge">Radius: ${$("radius").value} mi</span>
            <span class="badge good">Fallback active</span>
          </div>
          <div class="voteRow" style="justify-content:flex-start;margin-top:14px;">
            ${payload.links?.google ? `<a class="link" target="_blank" rel="noreferrer" href="${payload.links.google}">Google showtimes</a>` : ""}
            ${payload.links?.fandango ? `<a class="link" target="_blank" rel="noreferrer" href="${payload.links.fandango}">Fandango search</a>` : ""}
          </div>
          <div class="meta" style="margin-top:10px;">
            If MovieGlu is rate-limiting, this fallback keeps the page useful without breaking the UX.
          </div>
        </div>
      </div>
    `;
  }

  function renderResults() {
    const root = $("results");
    root.innerHTML = "";

    const events = selectedTitle ? lastEvents.filter(e => e.title === selectedTitle) : lastEvents;
    if (!selectedTitle) {
      root.innerHTML = `<div class="status">Select a poster to load showtimes.</div>`;
      return;
    }
    if (!events.length) {
      root.innerHTML = `<div class="status">No upcoming showtimes found (or providers returned limited data).</div>`;
      return;
    }

    const groups = { Preferred: [], Recommended: [], Standard: [] };
    for (const e of events) groups[e.bucket].push(e);

    const order = ["Preferred","Recommended","Standard"];
    for (const g of order) {
      const arr = groups[g];
      if (!arr.length) continue;

      arr.sort((a,b)=> a.when - b.when || (b.score - a.score) || ((a.distance??999)-(b.distance??999)));

      const byDay = new Map();
      for (const e of arr) {
        if (!byDay.has(e.dayKey)) byDay.set(e.dayKey, []);
        byDay.get(e.dayKey).push(e);
      }

      const section = document.createElement("div");
      section.className = "groups";

      const header = document.createElement("div");
      header.className = "gtitle";
      header.innerHTML = `<h2>${g}</h2><div class="hint">${
        g==="Preferred" ? "Premium formats + Smitty’s Sanford prioritized" :
        g==="Recommended" ? "Good options nearby" :
        "Everything else (still upcoming)"
      }</div>`;
      section.appendChild(header);

      for (const [dayKey, dayItems] of byDay.entries()) {
        const dayEl = document.createElement("div");
        const d = new Date(dayKey + "T00:00:00");
        dayEl.innerHTML = `<div class="meta" style="margin:10px 0 8px;">${fmtDay(d)}</div>`;

        for (const ev of dayItems) {
          const premium = PREMIUM.has(String(ev.format).toUpperCase());
          const preferred = isPreferredTheater(ev.cinema_name, ev.cinema_city);
          const voted = getLocalVotedSet().has(ev.showtimeKey);

          const badges = [
            premium ? `<span class="badge good">${ev.format}</span>` : `<span class="badge">${ev.format}</span>`,
            preferred ? `<span class="badge good">Smitty’s Sanford</span>` : ``,
            ev.distance!=null ? `<span class="badge">${ev.distance.toFixed(1)} mi</span>` : ``,
            `<span class="badge">Votes: <span id="v-${ev.showtimeKey}">${ev.votes ?? 0}</span></span>`
          ].filter(Boolean).join("");

          const links = [
            ev.booking_url ? { label:"Tickets", href: ev.booking_url } : null,
            { label:"Search", href:`https://www.google.com/search?q=${encodeURIComponent(ev.title + " showtimes " + lastZip)}` }
          ].filter(Boolean).map(l => `<a class="link" target="_blank" rel="noreferrer" href="${l.href}">${l.label}</a>`).join("");

          const el = document.createElement("div");
          el.className = "event";
          el.innerHTML = `
            <div>
              <h3>${ev.title}</h3>
              <div class="meta"><strong>${ev.start_time}</strong> • ${ev.cinema_name}${ev.cinema_city ? ` — ${ev.cinema_city}` : ""}</div>
              <div class="badges">${badges}</div>
            </div>
            <div class="right">
              <div class="voteRow">
                <button class="voteBtn" ${voted ? "disabled" : ""} data-vote="${ev.showtimeKey}" data-exp="${ev.when}">
                  ${voted ? "Voted" : "I’m in"}
                </button>
                ${links}
              </div>
              <div class="meta">Vote helps coordinate a time + theater.</div>
            </div>
          `;
          dayEl.appendChild(el);
        }

        section.appendChild(dayEl);
      }

      root.appendChild(section);
    }

    for (const b of root.querySelectorAll("button[data-vote]")) {
      b.addEventListener("click", async () => {
        const key = b.getAttribute("data-vote");
        const when = Number(b.getAttribute("data-exp"));
        if (!key || !when) return;
        try {
          b.disabled = true;
          const res = await vote(key, when);
          markVoted(key);
          const span = document.getElementById(`v-${key}`);
          if (span) span.textContent = String(res.votes);
          b.textContent = "Voted";
        } catch (e) {
          b.disabled = false;
          alert(e.message || String(e));
        }
      });
    }
  }
</script>
</body>
</html>